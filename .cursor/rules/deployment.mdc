---
alwaysApply: true
---

# Deployment

## Infrastructure

| Service | Provider |
|---------|----------|
| Code Hosting | GitHub |
| Web Deployment | Vercel |
| Desktop Build | Tauri |
| Backend/Database | Supabase |

---

## Environments

| Environment | URL | Purpose |
|-------------|-----|---------|
| Production | `https://www.ace-ielts.net` | Live service |
| Development | `http://localhost:3000` | Local web |
| Desktop Dev | `tauri dev` | Local desktop |

---

## Environment Variables

### Required (Frontend)
```env
VITE_SUPABASE_URL=<supabase_project_url>
VITE_SUPABASE_ANON_KEY=<supabase_anon_key>
```

### Project-Level Configuration (Edge Functions)
These are set as secrets in Supabase Edge Functions:
```env
GEMINI_API_KEY=<gemini_api_key>  # Project-level LLM API key
SUPABASE_URL=<supabase_project_url>
SUPABASE_SERVICE_ROLE_KEY=<service_role_key>
ENCRYPTION_KEY=<encryption_key_for_user_data>
```

**Note:** Project-level API keys are stored in environment variables (Edge Function secrets). User-level configuration (LLM provider selection, model parameters) is stored in the `user_settings` table.

### Desktop Only
```env
TAURI_PRIVATE_KEY=<signing_key>
TAURI_KEY_PASSWORD=<password>
```

### Usage in Code
```typescript
// packages/core/src/config/deployment.ts
export function getEnvironmentUrls() {
  const isDev = import.meta.env.DEV
  
  return {
    supabaseUrl: import.meta.env.VITE_SUPABASE_URL as string,
    supabaseAnonKey: import.meta.env.VITE_SUPABASE_ANON_KEY as string,
    appUrl: isDev ? "http://localhost:3000" : "https://www.ace-ielts.net",
  }
}
```

---

## Deployment Workflow

### GitHub → Vercel (Web)
1. Push to `main` branch triggers auto-deployment
2. PRs create preview deployments
3. Build command: `pnpm build:web`

**Vercel rules:**
- Never hardcode secrets in frontend
- Use `VITE_` prefix for client-side variables
- Set Production Environment Variables in Vercel dashboard

### Tauri (Desktop)
```bash
pnpm build:desktop      # Build
pnpm package:desktop    # Package (.msi, .dmg, .deb, .AppImage)
```

**Platforms:** Windows (.msi/.exe), macOS (.dmg/.app), Linux (.deb/.AppImage)

### Supabase

**Auth CORS - Allowed Redirect URLs:**
```
http://localhost:3000/**
https://www.ace-ielts.net/**
tauri://localhost/**
```

**Migrations:**
- Source of truth: `supabase/migrations/`
- ❌ Do NOT make schema changes via Dashboard SQL Editor

**Edge Functions:**
```bash
supabase functions serve <name>   # Local dev
supabase functions deploy <name>  # Production
```

Secrets managed in Dashboard → Edge Functions → Secrets

---

## LLM API Configuration

**Project-level keys:** Stored in Edge Function environment variables (Supabase Secrets)
- Edge Functions check `Deno.env.get("GEMINI_API_KEY")` first
- Falls back to user settings if project-level key not available

**User-level configuration:** Stored in `user_settings` table (encrypted)
- LLM provider selection (Gemini, OpenAI, etc.)
- Model parameters (temperature, topK, topP, etc.)
- User-specific API keys (optional, encrypted)

Edge Functions prioritize project-level keys, then user settings:
```typescript
// In Edge Functions
let geminiApiKey = Deno.env.get("GEMINI_API_KEY")
if (!geminiApiKey) {
  // Fallback to user settings
  const userSettings = await getUserSettings(userId)
  geminiApiKey = await decrypt(userSettings.llm_api_key_encrypted)
}
```

---

## Checklist

### Before Deploying
- [ ] `pnpm typecheck` passes
- [ ] `pnpm lint` passes
- [ ] Environment variables set in Vercel/Supabase
- [ ] Database migrations applied
- [ ] Edge Functions deployed

### Desktop Release
- [ ] Update version in `tauri.conf.json`
- [ ] Test on all platforms
- [ ] Sign binaries (macOS notarization, Windows signing)
- [ ] Update auto-updater endpoint